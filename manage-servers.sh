#!/bin/bash

# –°–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞–º–∏ DnD Game

case "$1" in
  "start")
    echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ DnD Game..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ —É–∂–µ —Å–µ—Ä–≤–µ—Ä—ã
    if ss -tlnp | grep -q ":8080"; then
      echo "‚ö†Ô∏è  Dev —Å–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080"
    else
      echo "üì± –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8080..."
      npm run dev > /dev/null 2>&1 &
      echo "‚úÖ Dev —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
    fi
    
    if ss -tlnp | grep -q ":9000"; then
      echo "‚ö†Ô∏è  Prod —Å–µ—Ä–≤–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9000"
    else
      echo "üåê –ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 9000..."
      npx serve -s dist -l 9000 > /dev/null 2>&1 &
      echo "‚úÖ Prod —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω"
    fi
    
    echo ""
    echo "üîó Dev: http://localhost:8080"
    echo "üîó Prod: http://localhost:9000"
    ;;
    
  "stop")
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ –ø–æ—Ä—Ç–∞–º
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é dev —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 8080)..."
    if ss -tlnp | grep -q ":8080"; then
      # –ù–∞—Ö–æ–¥–∏–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8080
      PID=$(ss -tlnp | grep ":8080" | awk '{print $7}' | cut -d',' -f1 | cut -d'=' -f2 | head -1)
      if [ ! -z "$PID" ]; then
        kill -9 $PID 2>/dev/null && echo "Dev —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (PID: $PID)" || echo "–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ dev —Å–µ—Ä–≤–µ—Ä–∞"
      else
        echo "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ PID dev —Å–µ—Ä–≤–µ—Ä–∞"
      fi
    else
      echo "Dev —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
    
    echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é prod —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 9000)..."
    if ss -tlnp | grep -q ":9000"; then
      # –ù–∞—Ö–æ–¥–∏–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞ –ø–æ—Ä—Ç—É 9000
      PID=$(ss -tlnp | grep ":9000" | awk '{print $7}' | cut -d',' -f1 | cut -d'=' -f2 | head -1)
      if [ ! -z "$PID" ]; then
        kill -9 $PID 2>/dev/null && echo "Prod —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (PID: $PID)" || echo "–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ prod —Å–µ—Ä–≤–µ—Ä–∞"
      else
        echo "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ PID prod —Å–µ—Ä–≤–µ—Ä–∞"
      fi
    else
      echo "Prod —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    fi
    
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    echo "–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    pkill -f "npm run dev" 2>/dev/null || true
    pkill -f "serve" 2>/dev/null || true
    
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
    ;;
    
  "status")
    echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–æ–≤ DnD Game:"
    echo ""
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
    if ss -tlnp | grep -q ":8080"; then
      echo "‚úÖ Dev —Å–µ—Ä–≤–µ—Ä (8080): –†–∞–±–æ—Ç–∞–µ—Ç"
    else
      echo "‚ùå Dev —Å–µ—Ä–≤–µ—Ä (8080): –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
    
    if ss -tlnp | grep -q ":9000"; then
      echo "‚úÖ Prod —Å–µ—Ä–≤–µ—Ä (9000): –†–∞–±–æ—Ç–∞–µ—Ç"
    else
      echo "‚ùå Prod —Å–µ—Ä–≤–µ—Ä (9000): –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    fi
    
    echo ""
    echo "üîç –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:"
    ss -tlnp | grep -E "(8080|9000)"
    ;;
    
  "restart")
    echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    echo "1/3: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–µ—Ä–≤–µ—Ä—ã..."
    $0 stop
    echo "2/3: –ñ–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    sleep 5
    echo "3/3: –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä—ã..."
    $0 start
    ;;
    
  "clean")
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–æ–≤ –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    
    echo "–ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–Ω—è—Ç—ã–µ –ø–æ—Ä—Ç—ã..."
    if ss -tlnp | grep -q ":8080"; then
      echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 8080 –∑–∞–Ω—è—Ç"
      ss -tlnp | grep ":8080"
    else
      echo "‚úÖ –ü–æ—Ä—Ç 8080 —Å–≤–æ–±–æ–¥–µ–Ω"
    fi
    
    if ss -tlnp | grep -q ":9000"; then
      echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 9000 –∑–∞–Ω—è—Ç"
      ss -tlnp | grep ":9000"
    else
      echo "‚úÖ –ü–æ—Ä—Ç 9000 —Å–≤–æ–±–æ–¥–µ–Ω"
    fi
    
    echo ""
    echo "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    ;;
    
  "force-stop")
    echo "üí• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤..."
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø–æ—Ä—Ç—ã
    echo "–û—Å–≤–æ–±–æ–∂–¥–∞—é –ø–æ—Ä—Ç 8080..."
    if ss -tlnp | grep -q ":8080"; then
      PID=$(ss -tlnp | grep ":8080" | awk '{print $7}' | cut -d',' -f1 | cut -d'=' -f2 | head -1)
      if [ ! -z "$PID" ]; then
        kill -9 $PID 2>/dev/null && echo "–ü–æ—Ä—Ç 8080 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω (PID: $PID)" || echo "–û—à–∏–±–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞ 8080"
      fi
    else
      echo "–ü–æ—Ä—Ç 8080 —Å–≤–æ–±–æ–¥–µ–Ω"
    fi
    
    echo "–û—Å–≤–æ–±–æ–∂–¥–∞—é –ø–æ—Ä—Ç 9000..."
    if ss -tlnp | grep -q ":9000"; then
      PID=$(ss -tlnp | grep ":9000" | awk '{print $7}' | cut -d',' -f1 | cut -d'=' -f2 | head -1)
      if [ ! -z "$PID" ]; then
        kill -9 $PID 2>/dev/null && echo "–ü–æ—Ä—Ç 9000 –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω (PID: $PID)" || echo "–û—à–∏–±–∫–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞ 9000"
      fi
    else
      echo "–ü–æ—Ä—Ç 9000 —Å–≤–æ–±–æ–¥–µ–Ω"
    fi
    
    # –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    echo "–û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
    pkill -f "npm" 2>/dev/null || true
    pkill -f "serve" 2>/dev/null || true
    pkill -f "vite" 2>/dev/null || true
    
    echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!"
    ;;
    
  "logs")
    echo "üìù –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:"
    echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞"
    tail -f /var/log/syslog | grep -E "(npm|serve|vite)" 2>/dev/null || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
    ;;
    
  *)
    echo "üéÆ DnD Game - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {start|stop|status|restart|clean|force-stop|logs}"
    echo ""
    echo "–ö–æ–º–∞–Ω–¥—ã:"
    echo "  start      - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã"
    echo "  stop       - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã"
    echo "  status     - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–æ–≤"
    echo "  restart    - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã"
    echo "  clean      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ—Ä—Ç—ã"
    echo "  force-stop - –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã"
    echo "  logs       - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
    echo ""
    echo "üì± Dev —Å–µ—Ä–≤–µ—Ä: http://localhost:8080"
    echo "üåê Prod —Å–µ—Ä–≤–µ—Ä: http://localhost:9000"
    ;;
esac

