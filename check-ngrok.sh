#!/bin/bash

echo "üåç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ngrok –¥–ª—è DnD –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ ngrok
if ! command -v ngrok &> /dev/null; then
    echo "‚ùå ngrok –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ngrok..."
    
    cd /workspace
    
    # –°–∫–∞—á–∏–≤–∞–µ–º ngrok v3
    echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º ngrok v3..."
    wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ ngrok —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ"
        
        # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º
        echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º ngrok..."
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        
        # –î–µ–ª–∞–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
        chmod +x ngrok
        
        # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ /usr/local/bin
        sudo mv ngrok /usr/local/bin/
        
        echo "‚úÖ ngrok —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ /usr/local/bin/"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ ngrok"
        exit 1
    fi
else
    echo "‚úÖ ngrok —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    ngrok version
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é
echo ""
echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ ngrok:"
ngrok version

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo ""
echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:"
if [ -f ~/.config/ngrok/ngrok.yml ]; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"
    echo "üìÅ –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ~/.config/ngrok/ngrok.yml"
else
    echo "‚ö†Ô∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    echo "üí° –í—ã–ø–æ–ª–Ω–∏—Ç–µ: ngrok config add-authtoken YOUR_TOKEN"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ DnD —Å–µ—Ä–≤–µ—Ä
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DnD —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 8082:"
if curl -s http://localhost:8082 > /dev/null; then
    echo "‚úÖ DnD —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8082"
else
    echo "‚ùå DnD —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8082"
    echo "üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: cd DND && npm run dev"
fi

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É ngrok
echo ""
echo "üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É ngrok:"
echo "=================================="
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª"
echo "2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: ngrok http 8082"
echo "3. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ HTTPS URL (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://abc123.ngrok.io)"
echo "4. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º URL —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏"
echo ""
echo "üåê –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫—Ä–æ–π—Ç–µ: http://localhost:8082/ngrok-test.html"
echo "üéÆ –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: http://localhost:8082"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ —É–∂–µ ngrok
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ ngrok:"
if pgrep -f "ngrok http 8082" > /dev/null; then
    echo "‚úÖ ngrok —É–∂–µ –∑–∞–ø—É—â–µ–Ω –¥–ª—è –ø–æ—Ä—Ç–∞ 8082"
    echo "üìã –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç—É–Ω–Ω–µ–ª–∏:"
    curl -s http://localhost:4040/api/tunnels | grep -o '"public_url":"[^"]*"' | cut -d'"' -f4
else
    echo "‚è≥ ngrok –Ω–µ –∑–∞–ø—É—â–µ–Ω –¥–ª—è –ø–æ—Ä—Ç–∞ 8082"
    echo "üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ngrok http 8082"
fi

echo ""
echo "‚ú® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"


